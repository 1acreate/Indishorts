<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Indi Shorts Studio — Mobile Edition</title>

<!-- JSZip + FileSaver -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
  :root{
    --bg-from:#0b2b40;
    --bg-to:#12263a;
    --card:#0e2433;
    --accent:#7de3b9;
    --muted:#b6d6e8;
    --btn:#ffb86b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg-from),var(--bg-to));color:#e6f6ff;min-height:100vh;padding:18px}
  .wrap{max-width:900px;margin:0 auto}
  header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#8dd3ff);display:flex;align-items:center;justify-content:center;font-weight:800;color:#042634}
  h1{margin:0;font-size:18px}
  p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}
  .card{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;margin-bottom:12px}
  label{font-size:13px;color:var(--muted);display:block;margin-top:10px}
  input[type=text], input[type=number], select, button {width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;margin-top:8px}
  .row{display:flex;gap:8px}
  .row> *{flex:1}
  .btn{padding:10px;border-radius:10px;border:0;font-weight:700}
  .btn.primary{background:var(--btn);color:#042634}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  #log{height:120px;overflow:auto;padding:8px;border-radius:8px;background:rgba(0,0,0,0.12);font-size:13px;color:#cfeaf8}
  #previews{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-top:10px}
  .short-card{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
  video{width:100%;border-radius:8px;background:black}
  .footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

  /* mobile first spacing */
  @media(min-width:700px){ .wrap{padding:0 12px} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">IS</div>
      <div>
        <h1>Indi Shorts Studio</h1>
        <p class="lead">Mobile edition — local MP4 → multiple shorts with audio. Fixed clean gradient UI.</p>
      </div>
    </header>

    <div class="card">
      <label>Choose local video (MP4) — tap to select</label>
      <input id="fileInput" type="file" accept="video/*">
      <label>Or paste direct MP4 URL (CORS-enabled)</label>
      <input id="mp4url" type="text" placeholder="https://example.com/video.mp4 (CORS required)">

      <div class="row" style="margin-top:8px">
        <div>
          <label>Shorts count</label>
          <input id="count" type="number" value="4" min="1" inputmode="numeric">
        </div>
        <div>
          <label>Duration (sec)</label>
          <input id="dur" type="number" value="15" min="1" inputmode="numeric">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="generate" class="btn primary">Generate Shorts</button>
        <button id="zipBtn" class="btn ghost" disabled>Download ZIP</button>
      </div>

      <div style="margin-top:8px;color:var(--muted);font-size:13px">Tip: Use a short test clip (30–60s) first. Long videos on low-end phones may take time.</div>
      <div style="margin-top:8px;">
        <div style="font-size:13px;color:var(--muted)">Logs:</div>
        <pre id="log"></pre>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Short Previews</strong><div style="font-size:13px;color:var(--muted)" id="summary"></div></div>
        <div style="color:var(--muted);font-size:13px">Offline • Mobile</div>
      </div>

      <div id="previews"></div>
    </div>

    <div class="footer">Made with ❤️ — Use only for videos you own or have permission to use.</div>
  </div>

  <!-- hidden video used for capture -->
  <video id="hiddenVideo" style="display:none"></video>

<script>
/*
Indi Shorts Studio — Mobile-friendly working version
- Uses captureStream on a hidden <video> (includes audio)
- Records segments with MediaRecorder into WebM + audio
- Provides per-short downloads and ZIP
- Works reliably on modern mobile Chrome/Edge/Firefox
- Note: True MP4 encoding requires ffmpeg (server or wasm) — offered later if needed
*/

const fileInput = document.getElementById('fileInput');
const mp4url = document.getElementById('mp4url');
const countEl = document.getElementById('count');
const durEl = document.getElementById('dur');
const generateBtn = document.getElementById('generate');
const zipBtn = document.getElementById('zipBtn');
const logEl = document.getElementById('log');
const previews = document.getElementById('previews');
const hiddenVideo = document.getElementById('hiddenVideo');
const summary = document.getElementById('summary');

let sourceBlob = null;
let shorts = []; // {name, blob}

function log(msg){
  const t = new Date().toLocaleTimeString();
  logEl.textContent += `[${t}] ${msg}\n`;
  logEl.scrollTop = logEl.scrollHeight;
  console.log(msg);
}

fileInput.addEventListener('change', e=>{
  if(e.target.files && e.target.files[0]){
    sourceBlob = e.target.files[0];
    log(`Local file selected: ${sourceBlob.name}`);
    summary.textContent = `Source: ${sourceBlob.name}`;
  }
});

// normalize fetch of URL (CORS required)
async function fetchRemote(url){
  log('Fetching remote MP4 — ensure CORS allowed');
  const r = await fetch(url);
  if(!r.ok) throw new Error('Fetch failed: ' + r.status);
  const b = await r.blob();
  return b;
}

// load video into hidden element and wait metadata
function loadVideo(blob){
  return new Promise((resolve,reject)=>{
    try {
      hiddenVideo.src = URL.createObjectURL(blob);
      hiddenVideo.onloadedmetadata = ()=> {
        resolve();
      };
      hiddenVideo.onerror = ()=> reject(new Error('Video load failed (CORS/format)'));
    } catch(e){ reject(e); }
  });
}

// record a segment starting at startSec for durationSec (includes audio)
async function recordSegment(startSec, durationSec, idx){
  return new Promise(async (resolve,reject)=>{
    try {
      const v = hiddenVideo;

      // prepare stream (includes audio if present in source)
      // some mobile browsers require play() before captureStream yields audio; we will try small play attempt.
      try { await v.play(); v.pause(); } catch(e) { /* ignore */ }

      // set start
      v.currentTime = Math.min(startSec, Math.max(0, v.duration - 0.05));

      // when seeked:
      v.onseeked = async () => {
        try {
          // tiny delay to let frame settle
          await new Promise(r=>setTimeout(r, 150));

          const stream = v.captureStream(); // includes audio track on most mobile browsers for local files
          const mimeCandidates = [
            'video/webm;codecs=vp8,opus',
            'video/webm;codecs=vp9,opus',
            'video/webm'
          ];
          let mime = mimeCandidates.find(m=>MediaRecorder.isTypeSupported(m)) || '';

          if(!mime){
            log('MediaRecorder MIME unsupported; using default.');
            mime = '';
          }
          const rec = new MediaRecorder(stream, mime ? {mimeType:mime} : undefined);
          const chunks = [];
          rec.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
          rec.onerror = e => { reject(new Error('Recording error: ' + e.message)); };
          rec.onstop = () => {
            const blob = new Blob(chunks, {type: chunks.length ? chunks[0].type : 'video/webm'});
            resolve(blob);
          };

          // start playback + recording
          v.play().catch(()=>{});
          rec.start(100);
          setTimeout(()=>{
            rec.stop();
            try { v.pause(); } catch(e){}
          }, durationSec*1000 + 200);
        } catch(err){ reject(err); }
      };

    } catch(e){ reject(e); }
  });
}

// main generate flow
generateBtn.addEventListener('click', async ()=>{
  previews.innerHTML = '';
  logEl.textContent = '';
  shorts = [];
  zipBtn.disabled = true;
  try {
    generateBtn.disabled = true;
    log('Preparing...');

    // determine source blob
    let blob = sourceBlob;
    if(!blob && mp4url.value && mp4url.value.trim() !== '') {
      blob = await fetchRemote(mp4url.value.trim());
      sourceBlob = blob;
      log('Remote file loaded into memory.');
      summary.textContent = `Source: remote`;
    }
    if(!blob) { alert('Select a local video or paste a direct MP4 URL'); generateBtn.disabled = false; return; }

    // load metadata
    await loadVideo(blob);
    const total = hiddenVideo.duration;
    log(`Video duration: ${total.toFixed(2)}s`);

    const count = Math.max(1, parseInt(countEl.value || '4'));
    const dur = Math.max(1, parseInt(durEl.value || '15'));
    summary.textContent = `Creating ${count} shorts • ${dur}s each`;

    // compute start times evenly
    const usable = Math.max(0, total - dur);
    const step = usable / Math.max(1, count);
    const starts = [];
    for(let i=0;i<count;i++){
      const s = Math.min(Math.round(i * step), Math.max(0, Math.floor(total - dur)));
      starts.push(s);
    }

    // record each segment sequentially
    for(let i=0;i<starts.length;i++){
      const s = starts[i];
      log(`Recording short ${i+1}/${starts.length} (start ${s}s) ...`);
      // small delay
      await new Promise(r=>setTimeout(r, 120));
      const blobClip = await recordSegment(s, dur, i+1);
      const name = `indi-short-${i+1}.webm`;
      shorts.push({name, blob: blobClip});
      // preview
      const url = URL.createObjectURL(blobClip);
      const card = document.createElement('div'); card.className = 'short-card';
      const v = document.createElement('video'); v.controls = true; v.src = url;
      const a = document.createElement('a'); a.href = url; a.download = name; a.textContent = '⬇️ Download'; a.style.display='inline-block'; a.style.marginTop='8px'; a.style.color='#bfe8ff';
      card.appendChild(v); card.appendChild(a);
      previews.appendChild(card);
    }

    log('All shorts recorded. You can download individually or use ZIP.');
    zipBtn.disabled = false;
  } catch (err) {
    console.error(err);
    log('Error: ' + (err && err.message ? err.message : err));
    alert('Error: ' + (err && err.message ? err.message : err));
  } finally {
    generateBtn.disabled = false;
  }
});

// Zip download
zipBtn.addEventListener('click', async ()=>{
  if(shorts.length === 0) return;
  zipBtn.disabled = true;
  log('Preparing ZIP...');
  const zip = new JSZip();
  for(let i=0;i<shorts.length;i++){
    const s = shorts[i];
    const arr = await s.blob.arrayBuffer();
    zip.file(s.name, arr);
  }
  const content = await zip.generateAsync({type:'blob'}, meta => { log(`Zipping: ${Math.round(meta.percent)}%`); });
  saveAs(content, 'indi-shorts-bundle.zip');
  log('ZIP ready.');
  zipBtn.disabled = false;
});

// basic support check
(function init(){
  if(!('MediaRecorder' in window) || !HTMLVideoElement.prototype.captureStream){
    alert('Your browser does not support required APIs (MediaRecorder / captureStream). Please use latest Chrome/Edge on mobile for best results.');
  } else {
    log('Ready. Choose a local video or paste a CORS-enabled URL. Use short test videos first on mobile.');
  }
})();
</script>
</body>
</html>